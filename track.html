<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Share Location</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>Share your location</h2>
      <p id="msg" class="small">This page will ask permission to share your location.</p>
      <button id="start">Start Sharing</button>
      <button id="stop" class="ghost" style="display:none;">Stop</button>
    </div>
  </div>
<script>
const token = location.hash.slice(1);
let watchId = null;

function send(pos) {
  const {latitude, longitude, accuracy} = pos.coords;
  const data = JSON.parse(localStorage.getItem(token) || '{"locations":[]}');
  data.locations.push({lat: latitude, lng: longitude, acc: accuracy, ts: Date.now()});
  localStorage.setItem(token, JSON.stringify(data));
}

document.getElementById('start').onclick = () => {
  if (!navigator.geolocation) return alert('Not supported');
  watchId = navigator.geolocation.watchPosition(send, err => alert(err.message), {enableHighAccuracy:true});
  document.getElementById('msg').textContent = 'Sharing... keep this page open.';
  document.getElementById('start').style.display='none';
  document.getElementById('stop').style.display='';
};

document.getElementById('stop').onclick = () => {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  document.getElementById('msg').textContent='Stopped.';
  document.getElementById('start').style.display='';
  document.getElementById('stop').style.display='none';
};
</script>
</body>
</html>
